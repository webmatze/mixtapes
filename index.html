<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue Mixtape Creator</title>
    <script src="https://unpkg.com/vue@3.4.23/dist/vue.global.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        .container { display: flex; justify-content: space-around; padding: 20px; }
        .side { width: 50%; border: 1px solid #ccc; padding: 10px; }
        .song { margin-bottom: 5px; }
        .song-details { display: flex; justify-content: space-between; }
    </style>
</head>
<body>
    <div id="app">
        <div id="spotifyCredentials" v-if="showSpotifyCredentials">
            <h2>Spotify API Credentials</h2>
            <p>Your Spotify credentials are not saved on our server and are only used on this client.</p>
            <p>You can create your own credentials here: <a href="https://developer.spotify.com/dashboard">https://developer.spotify.com/dashboard</a></p>
            <div>
                <label for="clientID">Client ID:</label>
                <input type="text" id="clientID" v-model="clientID" placeholder="Enter Client ID">
            </div>
            <div>
                <label for="clientSecret">Client Secret:</label>
                <input type="text" id="clientSecret" v-model="clientSecret" placeholder="Enter Client Secret">
            </div>
            <button @click="saveSpotifyCredentials">Save Credentials</button>
        </div>
        <div id="mixtape" v-else>
            <h1>Mixtape Creator</h1>
            <label for="mixtape-length">Select Mixtape Length:</label>
            <select v-model="mixtapeLength" @change="updateRemainingTime">
                <option value="3600">60 minutes</option>
                <option value="5400">90 minutes</option>
                <option value="6000">100 minutes</option>
                <option value="7200">120 minutes</option>
            </select>
            <div>
                <label for="mixtape-title">Mixtape Title:</label>
                <input type="text" id="mixtape-title" v-model="mixtapeTitle" placeholder="Enter Mixtape Title">
            </div>
            <div class="container">
                <div class="side">
                    <h2>Side A</h2>
                    <div>Remaining: {{ formattedTime(remainingTimeA) }}</div>
                    <ul>
                        <li v-for="song in sideA" :key="song.id" class="song-details">
                            {{ song.name }} by {{ song.artists[0].name }} - {{ formattedTime(song.duration_ms / 1000) }}
                            <button @click="removeSong('A', song)">Remove</button>
                            <button @click="moveSong('B', song)">Move to B</button>
                        </li>
                    </ul>
                </div>
                <div class="side">
                    <h2>Side B</h2>
                    <div>Remaining: {{ formattedTime(remainingTimeB) }}</div>
                    <ul>
                        <li v-for="song in sideB" :key="song.id" class="song-details">
                            {{ song.name }} by {{ song.artists[0].name }} - {{ formattedTime(song.duration_ms / 1000) }}
                            <button @click="removeSong('B', song)">Remove</button>
                            <button @click="moveSong('A', song)">Move to A</button>
                        </li>
                    </ul>
                </div>
            </div>
            <div>
                <input type="text" v-model="searchQuery" placeholder="Search for songs">
                <button @click="searchSongs">Search</button>
                <ul>
                    <li v-for="song in searchResults" :key="song.id" class="song">
                        {{ song.name }} ({{song.album.name}}) by {{ song.artists[0].name }} - {{ formattedTime(song.duration_ms / 1000) }}
                        <button @click="addSong('A', song)">Add to Side A</button>
                        <button @click="addSong('B', song)">Add to Side B</button>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, watch } = Vue;

        createApp({
            setup() {
                const mixtapeLength = ref(3600);
                const remainingTimeA = ref(mixtapeLength.value / 2);
                const remainingTimeB = ref(mixtapeLength.value / 2);
                const mixtapeTitle = ref('');
                const sideA = ref([]);
                const sideB = ref([]);
                const searchQuery = ref('');
                const searchResults = ref([]);
                const clientID = ref(localStorage.getItem('clientID') || '');
                const clientSecret = ref(localStorage.getItem('clientSecret') || '');

                watch(clientID, (newValue) => {
                    localStorage.setItem('clientID', newValue);
                });

                watch(clientSecret, (newValue) => {
                    localStorage.setItem('clientSecret', newValue);
                });
                const accessToken = ref('');
                const songs = ref([]);
                const showSpotifyCredentials = ref(clientID.value.trim() === '' && clientSecret.value.trim() === '');

                if (showSpotifyCredentials.value === false) {
                    getSpotifyAccessToken();
                }

                function saveSpotifyCredentials() {
                    if (clientID.value.trim() !== '' && clientSecret.value.trim() !== '') {
                        getSpotifyAccessToken();
                    } else {
                        alert("Please enter both Client ID and Client Secret.");
                    }
                }

                function getSpotifyAccessToken() {
                    const token = btoa(`${clientID.value.trim()}:${clientSecret.value.trim()}`);

                    // get a spotify access token
                    fetch('https://accounts.spotify.com/api/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'Authorization': `Basic ${token}`
                        },
                        body: 'grant_type=client_credentials'
                    })
                        .then(response => {
                            if (!response.ok && response.status === 400) {
                                throw new Error('Bad Request: Make sure your client credentials are correct.');
                            }
                            return response.json();
                        })
                        .then(data => {
                            accessToken.value = data.access_token;
                            console.log('Token:', data.access_token);
                            showSpotifyCredentials.value = false;
                        })
                        .catch(error => alert(error));

                    console.log("Spotify credentials saved successfully.");
                }

                function searchSongs() {
                    fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(searchQuery.value)}&type=track`, {
                        method: 'GET',
                        headers: { 'Authorization': `Bearer ${accessToken.value}` }
                    })
                        .then(response => response.json())
                        .then(data => {
                            searchResults.value = data.tracks.items;
                            console.log('Search Results:', data.tracks.items)
                        })
                        .catch(error => console.error('Error:', error));
                }

                function addSong(side, song) {
                    if (side === 'A' && remainingTimeA.value >= song.duration_ms / 1000) {
                        sideA.value.push(song);
                        remainingTimeA.value -= song.duration_ms / 1000;
                    } else if (side === 'B' && remainingTimeB.value >= song.duration_ms / 1000) {
                        sideB.value.push(song);
                        remainingTimeB.value -= song.duration_ms / 1000;
                    } else {
                        alert(`Cannot add "${song.title}" to Side ${side}. Not enough remaining time.`);
                    }
                }

                function removeSong(side, song) {
                    if (side === 'A') {
                        const index = sideA.value.findIndex(s => s.id === song.id);
                        if (index !== -1) {
                            sideA.value.splice(index, 1);
                        }
                        remainingTimeA.value += song.duration_ms / 1000;
                    } else {
                        const index = sideB.value.findIndex(s => s.id === song.id);
                        if (index !== -1) {
                            sideB.value.splice(index, 1);
                        }
                        remainingTimeB.value += song.duration_ms / 1000;
                    }
                }

                function moveSong(targetSide, song) {
                    removeSong(targetSide === 'A' ? 'B' : 'A', song);
                    addSong(targetSide, song);
                }

                function formattedTime(seconds) {
                    seconds = Math.round(seconds);
                    const min = Math.floor(seconds / 60);
                    const sec = seconds % 60;
                    return `${min}:${sec.toString().padStart(2, '0')}`;
                }

                function updateRemainingTime() {
                    remainingTimeA.value = mixtapeLength.value / 2;
                    remainingTimeB.value = mixtapeLength.value / 2;
                    sideA.value = [];
                    sideB.value = [];
                }

                return { showSpotifyCredentials, clientID, clientSecret, mixtapeLength, mixtapeTitle, remainingTimeA, remainingTimeB, sideA, sideB, searchQuery, searchResults, saveSpotifyCredentials, addSong, removeSong, moveSong, searchSongs, formattedTime, updateRemainingTime };
            }
        }).mount('#app');
    </script>
</body>
</html>
